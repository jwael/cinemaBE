import io.mockk.every
import io.mockk.mockk
import io.mockk.verify
import org.junit.jupiter.api.BeforeEach
import org.junit.jupiter.api.Test
import org.junit.jupiter.params.ParameterizedTest
import org.junit.jupiter.params.provider.CsvSource
import retrofit2.Response
import java.time.LocalDate
import kotlin.test.assertEquals
import kotlin.test.assertTrue

class CrmCustomerProviderAdapterRoleTest {

    private val crmClient = mockk<CrmClient>()
    private lateinit var adapter: CrmCustomerProviderAdapter

    @BeforeEach
    fun setUp() {
        adapter = CrmCustomerProviderAdapter(crmClient)
    }

    // ==================== TESTS PARAMÉTRÉS POUR createCrmRole ====================

    @ParameterizedTest
    @CsvSource(
        // contactRole, startDate, endDate, expectedRoleId, expectedStatus, responseStatus
        "PARTNER, 2024-01-01, 2024-12-31, ROLE_PARTNER_123, OK, OK",
        "MANAGER, 2024-01-01, null, ROLE_MANAGER_456, OK, OK",
        "ADMIN, 2024-01-01, 2024-06-30, ROLE_ADMIN_789, OK, OK",
        "USER, null, null, ROLE_USER_999, WARNING, WARNING"
    )
    fun `createCrmRole with successful response should return correct payload`(
        contactRole: String,
        startDate: String?,
        endDate: String?,
        expectedRoleId: String,
        expectedStatus: String,
        responseStatus: String
    ) {
        // Given
        val roleData = createCrmRoleData(
            contactRole = contactRole,
            startDate = startDate?.let { LocalDate.parse(it) },
            endDate = endDate?.let { LocalDate.parse(it) }
        )
        
        val roleResponse = RoleResponse(
            status = responseStatus,
            message = "Operation successful",
            roleId = expectedRoleId
        )
        val rolesResponse = RolesResponse(roles = listOf(roleResponse))
        
        every { 
            crmClient.createRole(
                correlationId = any(),
                contactId = "CONTACT_123",
                roleRequest = any()
            ).execute() 
        } returns Response.success(rolesResponse)

        // When
        val result = adapter.createCrmRole(roleData)

        // Then
        assertEquals(expectedRoleId, result.crmRoleId)
        assertEquals(RecordStepStatus.valueOf(expectedStatus), result.crmStatus)
        assertEquals("Operation successful", result.crmMessage)
        
        verify { 
            crmClient.createRole(
                correlationId = any(),
                contactId = "CONTACT_123",
                roleRequest = any()
            ).execute() 
        }
    }

    @Test
    fun `createCrmRole with empty roles list should return KO status`() {
        // Given
        val roleData = createCrmRoleData()
        val rolesResponse = RolesResponse(roles = emptyList())
        
        every { 
            crmClient.createRole(any(), any(), any()).execute() 
        } returns Response.success(rolesResponse)

        // When
        val result = adapter.createCrmRole(roleData)

        // Then
        assertEquals(RecordStepStatus.KO, result.crmStatus)
        assertEquals("Could not get response body from CRM Contacts Role API: empty body", result.crmMessage)
    }

    @Test
    fun `createCrmRole with null roles should return KO status`() {
        // Given
        val roleData = createCrmRoleData()
        val rolesResponse = RolesResponse(roles = null)
        
        every { 
            crmClient.createRole(any(), any(), any()).execute() 
        } returns Response.success(rolesResponse)

        // When
        val result = adapter.createCrmRole(roleData)

        // Then
        assertEquals(RecordStepStatus.KO, result.crmStatus)
        assertEquals("Could not get response body from CRM Contacts Role API: empty body", result.crmMessage)
    }

    @ParameterizedTest
    @CsvSource(
        // errorMessage, expectedErrorMessage
        "Validation failed, Validation failed",
        "Contact not found, Contact not found", 
        "Role already exists, Role already exists"
    )
    fun `createCrmRole with error response should return KO status`(
        errorMessage: String,
        expectedErrorMessage: String
    ) {
        // Given
        val roleData = createCrmRoleData()
        
        every { 
            crmClient.createRole(any(), any(), any()).execute() 
        } returns Response.error(400, mockErrorResponseBody("""{"message": "$errorMessage"}"""))

        // When
        val result = adapter.createCrmRole(roleData)

        // Then
        assertEquals(RecordStepStatus.KO, result.crmStatus)
        assertEquals(expectedErrorMessage, result.crmMessage)
    }

    @Test
    fun `createCrmRole with missing contactId should return KO status`() {
        // Given
        val roleData = createCrmRoleData(salesforceContactId = null)

        // When
        val result = adapter.createCrmRole(roleData)

        // Then
        assertEquals(RecordStepStatus.KO, result.crmStatus)
        assertTrue(result.crmMessage!!.contains("BLM Exception"))
    }

    @Test
    fun `createCrmRole with empty response body should return KO status`() {
        // Given
        val roleData = createCrmRoleData()
        
        every { 
            crmClient.createRole(any(), any(), any()).execute() 
        } returns Response.success(null)

        // When
        val result = adapter.createCrmRole(roleData)

        // Then
        assertEquals(RecordStepStatus.KO, result.crmStatus)
        assertEquals("Could not get response body from CRM Contacts Role API: empty body", result.crmMessage)
    }

    // ==================== TESTS PARAMÉTRÉS POUR updateCrmRole ====================

    @ParameterizedTest
    @CsvSource(
        // contactRole, startDate, endDate, roleId, expectedStatus, responseStatus
        "PARTNER, 2024-01-01, 2024-12-31, ROLE_PARTNER_123, OK, OK",
        "MANAGER, 2024-01-01, null, ROLE_MANAGER_456, OK, OK",
        "ADMIN, 2024-01-01, 2024-06-30, ROLE_ADMIN_789, WARNING, WARNING"
    )
    fun `updateCrmRole with successful response should return correct payload`(
        contactRole: String,
        startDate: String,
        endDate: String?,
        roleId: String,
        expectedStatus: String,
        responseStatus: String
    ) {
        // Given
        val roleData = createCrmRoleData(
            contactRole = contactRole,
            startDate = LocalDate.parse(startDate),
            endDate = endDate?.let { LocalDate.parse(it) },
            salesforceRoleId = roleId
        )
        
        val roleResponse = RoleResponse(
            status = responseStatus,
            message = "Update successful",
            roleId = roleId
        )
        val rolesResponse = RolesResponse(roles = listOf(roleResponse))
        
        every { 
            crmClient.updateRole(
                correlationId = any(),
                contactId = "CONTACT_123",
                roleId = roleId,
                roleRequest = any()
            ).execute() 
        } returns Response.success(rolesResponse)

        // When
        val result = adapter.updateCrmRole(roleData)

        // Then
        assertEquals(roleId, result.crmRoleId)
        assertEquals(RecordStepStatus.valueOf(expectedStatus), result.crmStatus)
        assertEquals("Update successful", result.crmMessage)
        
        verify { 
            crmClient.updateRole(
                correlationId = any(),
                contactId = "CONTACT_123",
                roleId = roleId,
                roleRequest = any()
            ).execute() 
        }
    }

    @Test
    fun `updateCrmRole with empty roles list should return KO status`() {
        // Given
        val roleData = createCrmRoleData(salesforceRoleId = "EXISTING_ROLE")
        val rolesResponse = RolesResponse(roles = emptyList())
        
        every { 
            crmClient.updateRole(any(), any(), any(), any()).execute() 
        } returns Response.success(rolesResponse)

        // When
        val result = adapter.updateCrmRole(roleData)

        // Then
        assertEquals(RecordStepStatus.KO, result.crmStatus)
        assertEquals("Could not get response body from CRM Contacts Role API: empty body", result.crmMessage)
    }

    @ParameterizedTest
    @CsvSource(
        // contactId, roleId, expectedErrorMessage
        "null, ROLE_123, BLM Exception: null",
        "CONTACT_123, null, BLM Exception: null", 
        "null, null, BLM Exception: null"
    )
    fun `updateCrmRole with missing required IDs should return KO status`(
        contactId: String?,
        roleId: String?,
        expectedErrorMessage: String
    ) {
        // Given
        val roleData = createCrmRoleData(
            salesforceContactId = contactId?.takeIf { it != "null" },
            salesforceRoleId = roleId?.takeIf { it != "null" }
        )

        // When
        val result = adapter.updateCrmRole(roleData)

        // Then
        assertEquals(RecordStepStatus.KO, result.crmStatus)
        assertEquals(expectedErrorMessage, result.crmMessage)
    }

    @Test
    fun `updateCrmRole with empty response body should return KO status`() {
        // Given
        val roleData = createCrmRoleData(salesforceRoleId = "EXISTING_ROLE")
        
        every { 
            crmClient.updateRole(any(), any(), any(), any()).execute() 
        } returns Response.success(null)

        // When
        val result = adapter.updateCrmRole(roleData)

        // Then
        assertEquals(RecordStepStatus.KO, result.crmStatus)
        assertEquals("Could not get response body from CRM Contacts Role API: empty body", result.crmMessage)
    }

    @Test
    fun `updateCrmRole with error response should return KO status`() {
        // Given
        val roleData = createCrmRoleData(salesforceRoleId = "EXISTING_ROLE")
        
        every { 
            crmClient.updateRole(any(), any(), any(), any()).execute() 
        } returns Response.error(500, mockErrorResponseBody("Internal server error"))

        // When
        val result = adapter.updateCrmRole(roleData)

        // Then
        assertEquals(RecordStepStatus.KO, result.crmStatus)
        assertEquals("Could not get response from CRM Contacts Role API", result.crmMessage)
    }

    // ==================== MÉTHODES UTILITAIRES ====================

    private fun createCrmRoleData(
        contactRole: String = "PARTNER",
        startDate: LocalDate? = LocalDate.of(2024, 1, 1),
        endDate: LocalDate? = LocalDate.of(2024, 12, 31),
        salesforceContactId: String? = "CONTACT_123",
        salesforceRoleId: String? = "ROLE_123"
    ): CrmRoleData {
        val crmData = CrmData(
            contactRole = contactRole,
            startDate = startDate,
            endDate = endDate,
            salesforceContactId = salesforceContactId,
            salesforceRoleId = salesforceRoleId
        )
        
        return CrmRoleData(
            reconciliationId = ReconciliationId("batch-ref", "row-ref"),
            batchId = 1L,
            rowNumber = 1,
            crmCustomerData = crmData
        )
    }

    private fun mockErrorResponseBody(errorContent: String): okhttp3.ResponseBody {
        return okhttp3.ResponseBody.create(
            okhttp3.MediaType.parse("application/json"),
            errorContent
        )
    }
}