import io.mockk.*
import kotlin.test.*
import java.time.Instant
import com.arval.blm.core.domain.model.*
import com.arval.blm.core.domain.model.crm.*
import com.arval.blm.core.domain.model.batch.*
import com.arval.blm.core.application.service.ImportCustomersService

class ImportCustomersServiceTest {

    private val recordStepEventRepositorySpi: RecordStepEventRepositorySpi = mockk(relaxed = true)
    private val clockProvider: ClockProvider = mockk()
    private val referenceIdFactory: ReferenceIdFactory = mockk()
    private val crmClsCustomerDataRepositorySpi: CrmClsCustomerDataRepositorySpi = mockk(relaxed = true)
    private val crmCustomerProviderSpi: CrmCustomerProviderSpi = mockk(relaxed = true)
    private val batchRepositorySpi: BatchRepositoryForContactsSpi = mockk(relaxed = true)

    private lateinit var sut: ImportCustomersService

    @BeforeTest
    fun setup() {
        every { clockProvider.now() } returns Instant.parse("2025-10-14T00:00:00Z")
        every { referenceIdFactory.generate() } returns ReferenceId("0123456789")
        every { crmClsCustomerDataRepositorySpi.save(any()) } answers { firstArg() }
        every { batchRepositorySpi.save(any()) } answers { firstArg() }
        every { recordStepEventRepositorySpi.save(any()) } answers { firstArg() }

        sut = ImportCustomersService(
            recordStepEventRepositorySpi,
            clockProvider,
            referenceIdFactory,
            crmClsCustomerDataRepositorySpi,
            crmCustomerProviderSpi,
            batchRepositorySpi
        )
    }

    @Test
    fun `apply should handle KO, create/update customer and create/update role`() {
        // GIVEN: un batch et plusieurs personalAccounts
        val batch = LoaderBatch(
            id = "BATCH_1",
            reference = ReferenceId("REF0000001"),
            fileName = "f.csv",
            triggeredBy = "user1",
            countryCode = CountryCode("FR"),
            status = LoaderBatchStatus.RUNNING,
            type = LoaderBatchType.CONTACTS,
            startDate = Instant.now(),
            endDate = null,
            totalContacts = 3
        )

        val faultyCustomer = CustomerPayload(
            rowNumber = 1,
            reconciliationId = ReconciliationId.parse("REF001-ROW001"),
            errorMessage = "SOME ERROR"
        )

        val customerToCreate = CustomerPayload(
            rowNumber = 2,
            reconciliationId = ReconciliationId.parse("REF002-ROW002"),
            errorMessage = null
        )

        val customerToUpdate = CustomerPayload(
            rowNumber = 3,
            reconciliationId = ReconciliationId.parse("REF003-ROW003"),
            errorMessage = null
        )

        // Slots pour vérifier les enregistrements
        val slotEvent = slot<RecordStepEvent>()
        every { recordStepEventRepositorySpi.save(capture(slotEvent)) } answers { firstArg() }

        // CRM Provider simulé
        every { crmCustomerProviderSpi.createCrmCustomer(any()) } returns CrmCustomerResponsePayload(RecordStepStatus.OK, "Customer created", "ACC001", null)
        every { crmCustomerProviderSpi.updateCrmCustomer(any()) } returns CrmCustomerResponsePayload(RecordStepStatus.OK, "Customer updated", "ACC002", null)
        every { crmCustomerProviderSpi.createRole(any()) } returns CrmRoleResponsePayload(RecordStepStatus.OK, "Role created", "ROLE001")
        every { crmCustomerProviderSpi.updateRole(any()) } returns CrmRoleResponsePayload(RecordStepStatus.OK, "Role updated", "ROLE002")

        // WHEN
        sut.apply(batch, listOf(faultyCustomer, customerToCreate, customerToUpdate))

        // THEN: KO event pour faultyCustomer
        assertEquals("SOME ERROR", slotEvent.captured.stepMessage)
        assertEquals(RecordStepStatus.KO, slotEvent.captured.stepStatus)

        // Vérifie que les fonctions CRM ont été appelées
        verify { crmCustomerProviderSpi.createCrmCustomer(any()) }
        verify { crmCustomerProviderSpi.updateCrmCustomer(any()) }
        verify { crmCustomerProviderSpi.createRole(any()) }
        verify { crmCustomerProviderSpi.updateRole(any()) }

        // Vérifie que les enregistrements BLM ont été sauvegardés
        verify { crmClsCustomerDataRepositorySpi.save(any()) }
        verify { recordStepEventRepositorySpi.save(any()) }
        verify { batchRepositorySpi.save(any()) }
    }
}